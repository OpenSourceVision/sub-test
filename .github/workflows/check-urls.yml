name: Check URLs

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Test URLs
        run: |
          cat url.txt | grep -v '^$' | sed 's/^- *//' | sed 's/"//g' | sed "s/^'//;s/'$//" | sort -u > /tmp/urls.txt
          
          > valid_urls.txt
          while IFS= read -r url; do
            if [ -n "$url" ]; then
              status=$(curl -sL -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 "$url" 2>/dev/null)
              if [ "$status" -lt 400 ]; then
                echo "- \"$url\"" >> valid_urls.txt
                echo "OK: $url (HTTP $status)"
              else
                echo "FAIL: $url (HTTP $status)"
              fi
            fi
          done < /tmp/urls.txt
          
          original=$(wc -l < /tmp/urls.txt)
          valid=$(wc -l < valid_urls.txt)
          invalid=$((original - valid))
          echo "原始: $original, 有效: $valid, 无效: $invalid"
          
          echo "原始网址: $original" > log.txt
          echo "去重数量: $original" >> log.txt
          echo "有效数量: $valid" >> log.txt
          echo "无效数量: $invalid" >> log.txt
          
          mv valid_urls.txt out.yaml

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git diff --staged --quiet || git commit -m "Update: $(date +%Y-%m-%d)"
          git push
